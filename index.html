<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <style>body { margin: 0; background: #222; overflow: hidden; }</style>
</head>
<body>
<div id="game-container"></div>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Получаем роль из URL: index.html?role=excavator
    const urlParams = new URLSearchParams(window.location.search);
    const ROLE = urlParams.get('role') || 'welder';

    // --- СЦЕНА 1: СВАРЩИК (Reaction / Rhythm) ---
    class WelderGame extends Phaser.Scene {
        constructor() { super({ key: 'welder' }); }
        create() {
            this.add.text(window.innerWidth/2, 50, 'СВАРКА: Лови зеленый центр!', { fontSize: '20px', fill: '#fff' }).setOrigin(0.5);
            
            // Зона и курсор
            this.zone = this.add.rectangle(window.innerWidth/2, window.innerHeight/2, 60, 200, 0x00ff00).setAlpha(0.5);
            this.cursor = this.add.rectangle(100, window.innerHeight/2, 20, 220, 0xffaa00);
            
            this.tweens.add({
                targets: this.cursor,
                x: window.innerWidth - 100,
                duration: 800,
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });

            this.quality = 50;
            this.scoreText = this.add.text(window.innerWidth/2, 100, 'Качество: 50%', { fontSize: '24px', fill: '#ff0' }).setOrigin(0.5);
            
            this.input.on('pointerdown', () => {
                const dist = Math.abs(this.cursor.x - this.zone.x);
                if(dist < 35) {
                    this.quality = Math.min(100, this.quality + 10);
                    this.cameras.main.shake(50, 0.005);
                } else {
                    this.quality = Math.max(0, this.quality - 15);
                    this.cameras.main.flash(100, 0xff0000);
                }
                this.scoreText.setText(`Качество: ${this.quality}%`);
            });

            this.time.delayedCall(10000, () => finishGame(this.quality, 'welder'), [], this);
        }
    }

    // --- СЦЕНА 2: ЭКСКАВАТОР (Keep in range) ---
    class ExcavatorGame extends Phaser.Scene {
        constructor() { super({ key: 'excavator' }); }
        create() {
            this.add.text(window.innerWidth/2, 50, 'ТРАНШЕЯ: Жми, держи уровень!', { fontSize: '20px', fill: '#fff' }).setOrigin(0.5);
            
            // Уровень земли (линия)
            this.add.rectangle(window.innerWidth/2, window.innerHeight/2, window.innerWidth, 4, 0x00ff00);
            
            // Ковш
            this.bucket = this.add.rectangle(window.innerWidth/2, window.innerHeight/2, 50, 50, 0xffff00);
            this.physics.add.existing(this.bucket);
            this.bucket.body.setGravityY(600);
            this.bucket.body.setCollideWorldBounds(true);

            this.deviation = 0; // Накопленная ошибка
            
            this.input.on('pointerdown', () => {
                this.bucket.body.setVelocityY(-300);
            });
            
            this.scoreText = this.add.text(window.innerWidth/2, 100, 'Отклонение: 0 см', { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
            
            this.time.addEvent({
                delay: 500,
                loop: true,
                callback: () => {
                    const diff = Math.abs(this.bucket.y - window.innerHeight/2);
                    if(diff > 50) this.deviation += Math.floor(diff/10);
                    this.scoreText.setText(`Отклонение: ${this.deviation} см`);
                }
            });

            this.time.delayedCall(10000, () => {
                // Переводим отклонение в качество (0 отклонения = 100%, 200+ = 0%)
                let q = Math.max(0, 100 - (this.deviation / 2));
                finishGame(Math.floor(q), 'excavator');
            }, [], this);
        }
    }

    // --- СЦЕНА 3: ЗАГЛУШКА (Для остальных ролей) ---
    class GenericGame extends Phaser.Scene {
        constructor() { super({ key: 'generic' }); }
        create() {
            this.add.text(window.innerWidth/2, window.innerHeight/2 - 50, 'РАБОТА...', { fontSize: '30px' }).setOrigin(0.5);
            this.add.text(window.innerWidth/2, window.innerHeight/2 + 50, 'Тапай быстро!', { fontSize: '16px' }).setOrigin(0.5);
            
            this.clicks = 0;
            this.input.on('pointerdown', () => {
                this.clicks++;
                this.cameras.main.shake(20, 0.002);
            });

            this.time.delayedCall(5000, () => {
                let q = Math.min(100, this.clicks * 4); // Надо 25 кликов за 5 сек
                finishGame(q, ROLE);
            }, [], this);
        }
    }

    // --- ОБЩАЯ ФУНКЦИЯ ЗАВЕРШЕНИЯ ---
    function finishGame(score, role) {
        tg.sendData(JSON.stringify({ role: role, quality: score }));
    }

    // --- КОНФИГ ---
    const config = {
        type: Phaser.AUTO,
        parent: 'game-container',
        width: window.innerWidth,
        height: window.innerHeight,
        physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
        scene: [WelderGame, ExcavatorGame, GenericGame]
    };

    const game = new Phaser.Game(config);

    // Запуск нужной сцены
    if (ROLE === 'excavator') game.scene.start('excavator');
    else if (ROLE === 'welder') game.scene.start('welder');
    else game.scene.start('generic'); // Для геодезиста, водителя и т.д.

</script>
</body>
</html>
